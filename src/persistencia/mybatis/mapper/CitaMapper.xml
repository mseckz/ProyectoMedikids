<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
 <mapper namespace="persistencia.mybatis.mapper.CitaMapper">
 	
 	<resultMap type="cita" id="rmCita">
 		<id column="id_cita" property="id"/>
 		<result column="codigo_cita" property="codigo"/>
 		<result column="tipo_reserva" property="tipoReserva"/>
 		<result column="fecha_atencion" property="fechaAtencion"/>
 		<association property="historiaClinica" javaType="historiaclinica">
 			<id column="id_hc" property="id"/>
 			<result column="nom_paciente" property="nombrePaciente"/>
 			<result column="apellido_paterno_paciente" property="apellidoPaternoPaciente"/>
 			<result column="apellido_materno_paciente" property="apellidoMaternoPaciente"/>
 		</association>
 		<association property="consultorio" javaType="consultorio">
 			<id column="id_consultorio" property="id"/>
 			<result column="cod_consultorio" property="codigo"/>		
 		</association>
 	</resultMap>
 	
 	<select id="obtenerCitas" resultMap="rmCita">
		select id_cita,codigo_cita,tipo_reserva,fecha_atencion,c.id_hc,h.nom_paciente,h.apellido_paterno_paciente,
		h.apellido_materno_paciente, c.id_consultorio,cn.cod_consultorio
		from cita c inner join HISTORIA_CLINICA h on c.id_hc = c.id_hc
		inner join CONSULTORIO cn on c.id_consultorio = cn.id_consultorio
		where estado_cita = 'RESERVA'
 	</select>
 	
 	<insert id="registrarCita" parameterType="cita">
 		INSERT INTO CITA (codigo_cita,id_hc, personal_registro,tipo_reserva,id_consultorio,fecha_atencion,hora_atencion,monto_pago)
 		values (#{codigo},#{historiaClinica.id},#{personalRegistro.id},#{tipoReserva},
 		#{consultorio.id},#{fechaAtencion}, #{horaAtencion},#{monto})
 	</insert>
 	
 	<!-- horas disponibles del consultorio dependiendo fecha y turno -->
 	<select id="horasDisponibles" parameterType="map" resultType="String">
 		SELECT hora from HORAS_DIA where hora 
		not in 
		(select hora_atencion from cita c 
		 where c.id_consultorio = #{idConsultorio} and c.fecha_atencion = #{fecha}
		 and c.estado_cita = 'RESERVA')
		and hora in
		(select hora from HORAS_DIA inner join TURNO t on
		 <![CDATA[ hora >= t.hora_inicio and hora < t.hora_fin ]]>
		 where id_turno in 
		 (SELECT h.id_turno from HORARIOS h
		  where id_consultorio = #{idConsultorio} and h.id_dia = DATEPART(weekday, #{fecha})-1 and h.estado = 1))
 	</select>
 	
 	
 </mapper>